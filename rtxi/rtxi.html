<!DOCTYPE html>
<html>

<head>
        <link href="../css/style.css" rel="stylesheet" />
        <link href="../css/prism.css" rel="stylesheet" />
        <script src="../js/MathJax-master/MathJax.js?config=TeX-AMS_HTML-full" async></script>
</head>

<body>
        <script src="../js/prism.js"></script>
        <div class="header">
                <img src="../logo_openqsa.png" />
                <span class="home" onclick="window.location='../index.html'">&#x23CE;</span>
        </div>
        <div class="inner">
                <h1>Summary</h1>
                <ul>
                        <li><a href="#install_rtxi">Install RTXI</a></li>
                        <li><a href="#build_programs">Build Programs</a></li>
                        <li><a href="#configure_rtxi">Configure RTXI</a></li>
                        <li><a href="#run_process">Run Process (step by step)</a></li>
                </ul>
                <a name="install_rtxi">
                        <h1>Install RTXI</h1>
                </a>
                <h2>Basic installation</h2>
                <p>It is recommended to install <b>RTXI 2.2</b> and follow instructions from the <a href="http://rtxi.org"
                                target="_blank">official
                                web site</a>.</p>
                <h2>Ubuntu kernel</h2>
                <p>In case of software updates, it is important to keep the <code>Xenomai-patched</code> kernel because
                        it
                        provides the real
                        time support for data acquisition. If the default kernel has been changed after an update, it
                        is still
                        possible to press
                        SHIFT at boot to display the GRUB menu, then select "Advanced Options for Ubuntu" and choose
                        the
                        <code>Xenomai-patched</code>
                        kernel.</p>
                <h2>Decimal separator</h2>
                <p>It is necessary to use the <b>point</b> instead of the comma as the decimal separator. This
                        can be adjusted in Ubuntu (if needed) as follows</p>
                <ul>
                        <li>System Settings</li>
                        <li>Language Support</li>
                        <li>Regional Formats</li>
                        <li>Select "English" for "Display numbers, dates and currency"</li>
                </ul>
                <h2>VirtualBox</h2>
                <p>The RTXI operating system can also be installed as a virtual machine in VirtualBox. The package
                        <code>RTXI 2.2 amd64-generic</code>
                        was tested successfully with OpenQSA. However, the recent VirtualBox Guest Additions sometimes
                        do not
                        work, the following procedure can be used to install an older version:</p>
                <p>Download VirtualBox Guest Additions 5.1.30 with command:</p>
                <pre><code class="language-bash">wget https://download.virtualbox.org/virtualbox/5.1.30/VBoxGuestAdditions_5.1.30.iso</code></pre>
                <p>Mount the ISO:</p>
                <pre><code class="language-bash">sudo mkdir /media/iso
sudo mount -o loop VBoxGuestAdditions_5.1.30.iso /media/iso</code></pre>
                <p>Install additions:</p>
                <pre><code class="language-bash">sudo apt-get install build-essential
sudo apt-get install module-assistant
sudo m-a prepare
cd /media/iso
sudo ./VBoxLinuxAdditions.run</code></pre>
                <p>Finally, unmount the ISO:</p>
                <pre><code class="language-bash">sudo umount /media/iso</code></pre>
                <a name="build_programs">
                        <h1>Build Programs</h1>
                </a>
                <h2>Clone repository</h2>
                <p>OpenQSA provides three C++ packages to set up an RTXI experiment:</p>
                <ul>
                        <li>Global utilities <b>qsa</b></li>
                        <li>RTXI module <b>qsa_stimulation</b> to generate a QSA stimulation</li>
                        <li>RTXI module <b>qsa_response</b> to record responses to signals generated by <b>qsa_stimlulation</b></li>
                </ul>
                <p>The three packages are regrouped in a single git repository that can be cloned in command line:</p>
                <pre><code class="language-bash">mkdir openqsa ; cd openqsa
git clone https://github.com/openqsa/rtxi</code></pre>
                <h2>Compilation</h2>
                <p>The package <b>qsa</b> must be compiled before the two other <b>qsa_stimulation</b> and <b>qsa_response</b>
                        because it generates a library file <code>qsa.a</code></p>
                <h3>Compile qsa</h3>
                <pre><code class="language-bash">cd rtxi/qsa
make clean ; make</code></pre>
                <p>The library file <code>qsa.a</code> should have been generated. It will be used by the two other
                        packages.</p>
                <h3>Compile qsa_stimulation</h3>
                <pre><code class="language-bash">cd rtxi/qsa_stimulation
make clean ; make
sudo make install</code></pre>
                <h3>Compile qsa_response</h3>
                <pre><code class="language-bash">cd rtxi/qsa_response
make clean ; make
sudo make install</code></pre>
                <h2>Example with neuron</h2>
                <p>In order to illustrate the procedure, we also install the RTXI module <b>neuron</b>:</p>
                <pre><code class="language-bash">git clone https://github.com/rtxi/neuron
cd neuron ; make clean ; make ; sudo make install</code></pre>
                <a name="configure_rtxi">
                        <h1>Configure RTXI</h1>
                </a>
                <p>The RTXI system can be launched from the general Ubuntu menu.</p>
                <h2>Panel qsa_stimulation</h2>
                <p>The RTXI module <b>qsa_stimulation</b> is a multisinusoidal stimulation generator that conforms to
                        the QSA
                        protocol. It is designed to be synchronized in real time with the RTXI module <b>qsa_response</b>
                        that
                        records the responses and exports them to a fully exploitable JSON file format.</p>
                <p>Select menu "Modules" / "Load Plugins", then choose <code>qsa_stimulation.o</code> ; a panel like
                        this
                        should appear:</p>
                <img src="qsa_stimulation.png" width="500px" />
                <p>It is composed of five important elements:</p>
                <ul>
                        <li>Parameter values, with defaults chosen to work with the RTXI module <b>neuron</b></li>
                        <li>Text box describing the generated stimulation</li>
                        <li>Graphic box representing generated frequencies</li>
                        <li>Button "Apply stimulation" to apply the stimulation, which is synchronized with the RTXI
                                module <b>qsa_response</b></li>
                        <li>Button "Copy stimulation" to copy the generated stimulation to the clipboard, that must be
                                pasted
                                into the RTXI module <b>qsa_response</b></li>
                </ul>
                <p>A new random stimulation is generated each time the button "Modify" is pressed.</p>
                <p>The generated stimulation has the following schema for a single trace:</p>
                <img src="qsa_stimulation_shape.png" width="600px" />
                <p>The full stimulation concatenates any number of traces sequentially. Multiple traces are useful to
                        make
                        averaging and reduce the experimental noise.</p>
                <p>The red areas indicate parts of the signal that can be recorded (including the responses) to a JSON
                        file
                        for further mathematical analyses. The gray areas are applied but not recorded.</p>
                <p>The step is applied before the two multisines to record transients until the steady state, then
                        it is applied again after the multisines for stabilization.</p>
                <p>The multisinusoidal waveform is applied twice as a sum of \(N\) sinusoids:</p>
                \[s(t) = \frac{1}{N} \sum_{i=1}^{N} A \sin(2 \pi f_k t + \phi_k)\]
                <p>where \(t \in [0,\textrm{duration}]\), \(A\) is the amplitude, \(f_k\) are random frequencies and
                        \(\phi_k\)
                        are random phases. The \(f_k\) must be integer multiples of the inverse of duration, which is
                        the
                        lowest possible frequency.</p>
                <p>The multisinusoidal waveform is applied first (gray part) to stabilize the response, then it is
                        applied
                        again to record the stable response. Each \(f_k\) must be an integer multiple of \(1 /
                        \textrm{duration}\). Thus, \(2 \pi f_k \textrm{duration}\) is an integer multiple of \(2 \pi\),
                        which
                        implies
                        that the junction between the two multisines is continuous at \(t = \textrm{duration}\).</p>
                <table class="grid">
                        <thead>
                                <th class="grid">Field</th>
                                <th class="grid">Description</th>
                        </thead>
                        <tbody>
                                <tr>
                                        <td class="grid"><code>MinFrequency</code></td>
                                        <td class="grid">Minimal frequency that can be generated (hertz). Must be an
                                                integer
                                                multiple
                                                of <code>1 / duration</code>.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>MaxFrequency</code></td>
                                        <td class="grid">Maximum frequency that can be generated (hertz). Must be
                                                integer
                                                multiple of
                                                <code>1 / duration</code>.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>SeedFrequencies</code></td>
                                        <td class="grid">Positive integer to seed the random frequency generator, or
                                                zero to be
                                                always
                                                random.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>Duration</code></td>
                                        <td class="grid">The multisine duration (seconds), applied twice. The inverse
                                                <code>1 / duration</code>
                                                must have finite number of digits after the decimal point.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>Amplitude</code></td>
                                        <td class="grid">Constant amplitude of each individual sinusoid. Note that the
                                                multisine
                                                superposition is divided by the number of sinusoids.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>SeedPhase</code></td>
                                        <td class="grid">Positive integer to seed the random phase generator, or zero
                                                to be
                                                always
                                                random.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>RestLevel</code></td>
                                        <td class="grid">Offset of the signal at rest, which is applied as soon as the
                                                "Modify"
                                                button
                                                is pressed.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>StepLevel</code></td>
                                        <td class="grid">Offset of the signal determining the steady state.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>StepDelay</code></td>
                                        <td class="grid">Step delay (seconds) to reach the steady state before and
                                                after the
                                                multisine.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>DropDelay</code></td>
                                        <td class="grid">Delay (seconds) at rest level just after the drop of the step
                                                level.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>TraceCount</code></td>
                                        <td class="grid">Number of traces to be recorded.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>TracePause</code></td>
                                        <td class="grid">Pause (seconds) at rest level between each trace. This pause
                                                is
                                                applied just
                                                after the drop delay.</td>
                                </tr>
                                <tr>
                                        <td class="grid"><code>TraceAlternance</code></td>
                                        <td class="grid">Set to +1 to ignore. Otherwise set to -1 to alternate the sign
                                                of the
                                                multisine at
                                                each trace.</td>
                                </tr>
                        </tbody>
                </table>
                <h2>Panel qsa_response</h2>
                <p>The RTXI module <b>qsa_response</b> records both a stimulation and its synchronized response.</p>
                <p>Select menu "Modules" / "Load Plugins", then choose <code>qsa_response.o</code> ; a panel like this
                        should
                        appear:</p>
                <img src="qsa_response.png" width="300px" />
                <p>It is composed of five important elements:</p>
                <ul>
                        <li>Text box describing the generated stimulation</li>
                        <li>Button "Paste stimulation" to paste the stimulation copied from the RTXI module <b>qsa_stimulation</b></li>
                        <li>Button "Record sequence" to prepare recording, which really starts only when the button
                                "Apply
                                stimulation" is pressed in the RTXI module <b>qsa_stimulation</b></li>
                        <li>Button "Cancel" to cancel recording</li>
                        <li>Button "Save to disk" to export the recorded sequence to a JSON file</li>
                </ul>
                <p>The button "Modify" must be pressed after "Paste stimulation" and before "Record sequence".</p>
                <p>The different parts of the signal are recognized and can be exported to a JSON file with the
                        following
                        structure:</p>
                <pre><code class="language-json">{
        dt: <em>float</em>,
        duration: <em>float</em>,
        frequencies: <em>array[float]</em>,
        amplitudes: <em>array[float]</em>,
        phases: <em>array[float]</em>,
        rest_level: <em>float</em>,
        step_level: <em>float</em>,
        step_delay: <em>float</em>,
        drop_delay: <em>float</em>,
        trace_count: <em>int</em>,
        trace_pause: <em>float</em>,
        trace_alternance: <em>int</em>,
        traces:
        [
                {
                        step:
                        {
                                time: <em>array[float]</em>,
                                stimulation: <em>array[float]</em>,
                                response: <em>array[float]</em>
                        },
                        multisine:
                        {
                                time: <em>array[float]</em>,
                                stimulation: <em>array[float]</em>,
                                response: <em>array[float]</em>
                        },
                        drop:
                        {
                                time: <em>array[float]</em>,
                                stimulation: <em>array[float]</em>,
                                response: <em>array[float]</em>
                        }
                },
                ... // idem for other traces
        ]
}</code></pre>
                <p>Note that in the JSON file, the field "amplitudes" is an array in which all values are equal to the
                        global amplitude \(A\). Indeed, non-flat amplitudes are supported by QSA analysis but not by
                        the
                        RTXI module <b>qsa_stimulation</b>. The JSON file can be directly used with Python:</p>
                <pre><code class="language-python">import json
file = open(filename, 'r')
text = file.read()
data = json.loads(text)
print(data['duration'])</code></pre>
                <p>as well as with Matlab:</p>
                <pre><code class="language-matlab">text = fileread(filename);
data = jsondecode(text);
data.duration</code></pre>
                <h2>Panel for model or experiment</h2>
                <p>The response must be generated by a specific RTXI module implementing a model or a biological
                        experiment.
                        Here, we illustrate with the RTXI module <b>neuron</b>, which implements a classic
                        Hodgkin-Huxley model
                        neuron.</p>
                <p>Select menu "Modules" / "Load Plugins", then choose <code>neuron.o</code> ; a panel like this should
                        appear:</p>
                <img src="neuron.png" width="250px" />
                <p>A description of parameters can be found on the web site <a href="https://github.com/RTXI/neuron"
                                target="_blank">RTXI/neuron</a></p>
                <h2>Panel connector</h2>
                <p>The three RTXI modules <b>qsa_stimulation</b>, <b>qsa_response</b> and <b>neuron</b> must be
                        connected to
                        cooperate.</p>
                <p>Select menu "System" / "Connector" ; a panel like this should appear:</p>
                <img src="connector.png" width="550px" />
                <p>The four connections shown in the text box "Connections" must be defined as follows:</p>
                <img src="connections.png" width="550px" />
                <table class="grid">
                        <thead>
                                <th class="grid">Name</th>
                                <th class="grid">Description</th>
                        </thead>
                        <tbody>
                                <tr>
                                        <td class="grid"><code style="color: red;">Iqsa</code></td>
                                        <td class="grid">Current generated by <b>qsa_stimulation</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: blue;">Iapp</code></td>
                                        <td class="grid">Current applied to <b>neuron</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: blue;">Iqsa</code></td>
                                        <td class="grid">Current recorded by <b>qsa_response</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: red;">Vm</code></td>
                                        <td class="grid">Membrane voltage measured from <b>neuron</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: blue;">Vm</code></td>
                                        <td class="grid">Membrane voltage recorded by <b>qsa_response</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: red;">Sync</code></td>
                                        <td class="grid">Synchronization signal generated by <b>qsa_stimulation</b></td>
                                </tr>
                                <tr>
                                        <td class="grid"><code style="color: blue;">Sync</code></td>
                                        <td class="grid">Synchronization signal recorded by <b>qsa_response</b></td>
                                </tr>
                        </tbody>
                </table>
                <a name="run_process">
                        <h1>Run Process (step by step)</h1>
                </a>
                <h2>&#x2460;</h2>
                <p>Open the four panels:</p>
                <ul>
                        <li>Module <b>qsa_stimulation</b></li>
                        <li>Module <b>qsa_response</b></li>
                        <li>Module <b>neuron</b> or experimental device</li>
                        <li>Connector</li>
                </ul>
                <h2>&#x2461;</h2>
                <p>Make the four connections with the connector.</p>
                <img src="run_connector.png" width="400px" />
                <h2>&#x2462;</h2>
                <p>In <b>qsa_stimulation</b>, set parameters then click button "Modify" as many times as desired to
                        generate
                        random
                        stimulations. When a good stimulation is chosen, press button "Copy stimulation".</p>
                <img src="run_parameters.png" width="450px" />
                <h2>&#x2463;</h2>
                <p>In <b>qsa_response</b>, press button "Paste stimulation" then click button "Modify".</p>
                <img src="run_paste.png" width="250px" />
                <h2>&#x2464;</h2>
                <p>In <b>neuron</b>, adjust parameters then press button "Modify". Or configure an experimental device
                        in case
                        of a real biological experiment.</p>
                <img src="run_neuron.png" width="250px" />
                <h2>&#x2465;</h2>
                <p>Release button "Pause" in panels <b>qsa_stimulation</b>, <b>qsa_response</b> and <b>neuron</b>.</p>
                <h2>&#x2466;</h2>
                <p>In <b>qsa_response</b>, press button "Record sequence". The module will wait for the stimulation
                        before
                        starting the recording.</p>
                <img src="run_record.png" width="250px" />
                <h2>&#x2467;</h2>
                <p>In <b>qsa_stimlulation</b>, press button "Apply stimulation" to start the stimulation. The <b>qsa_response</b>
                        will start recording as well.</p>
                <img src="run_apply.png" width="400px" />
                <h2>&#x2468;</h2>
                <p>Wait until the whole stimulation has been applied. Then, in <b>qsa_response</b> the button "Save to
                        disk" will become active. Click it to save the recorded data to a JSON file. It is recommended
                        to use
                        the file extension <code>.json</code></p>
                <img src="run_save.png" width="250px" />
        </div>
</body>

</html>